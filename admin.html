<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeSnap Admin Panel</title>
    
    <style>
        body { background-color: #f3f4f6; color: #1f2937; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD-tG7cRV5v9k5fb_QE2dLo0CnYEHtV_wE",
            authDomain: "vibesnap-live.firebaseapp.com",
            projectId: "vibesnap-live",
            storageBucket: "vibesnap-live.firebasestorage.app",
            messagingSenderId: "558903357110",
            appId: "1:558903357110:web:7f602f38208645eca3c017"
        };

        // FIXED ID based on your database
        const appId = "vibesnap-live";

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch(e) { console.error("Firebase Init Error", e); }

        const provider = new GoogleAuthProvider();

        const AUTHORIZED_EMAILS = [
            'ande.uday143@gmail.com', 
            'k.rohith0507@gmail.com', 
            'vibesnapteam@gmail.com'
        ];

        // --- AUTH LOGIC ---
        const loginOverlay = document.getElementById('loginOverlay');
        const dashboard = document.getElementById('dashboard');
        const loginBtn = document.getElementById('googleLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authErrorMsg = document.getElementById('authErrorMsg');

        if(loginBtn) {
            loginBtn.addEventListener('click', () => {
                signInWithPopup(auth, provider)
                    .then((result) => checkUserAccess(result.user))
                    .catch((error) => {
                        console.error("Login Error:", error);
                        if(authErrorMsg) {
                            authErrorMsg.textContent = "Login failed: " + error.message;
                            authErrorMsg.classList.remove('hidden');
                        }
                    });
            });
        }

        if(logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                signOut(auth).then(() => window.location.reload());
            });
        }

        onAuthStateChanged(auth, (user) => {
            if (user) checkUserAccess(user);
            else showLogin();
        });

        function checkUserAccess(user) {
            if (AUTHORIZED_EMAILS.includes(user.email)) {
                if(document.getElementById('userEmailDisplay')) 
                    document.getElementById('userEmailDisplay').textContent = user.email;
                showDashboard();
                loadBookings();
                loadTickets(); // Load Tickets as well
            } else {
                signOut(auth);
                if(authErrorMsg) {
                    authErrorMsg.textContent = "Access Denied: Unauthorized Email";
                    authErrorMsg.classList.remove('hidden');
                }
                showLogin();
            }
        }

        function showLogin() {
            if(loginOverlay) loginOverlay.classList.remove('hidden');
            if(dashboard) dashboard.classList.add('hidden');
        }

        function showDashboard() {
            if(loginOverlay) loginOverlay.classList.add('hidden');
            if(dashboard) dashboard.classList.remove('hidden');
        }

        // --- BOOKINGS LOGIC ---
        function loadBookings() {
            const bookingsTableBody = document.getElementById('bookingsTableBody');
            const bookingsRef = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
            
            onSnapshot(bookingsRef, (snapshot) => {
                bookingsTableBody.innerHTML = '';
                
                if (snapshot.empty) {
                    bookingsTableBody.innerHTML = '<tr><td colspan="10" class="p-8 text-center text-gray-500 font-medium">No bookings found yet.</td></tr>';
                    return;
                }

                const bookings = [];
                snapshot.forEach(doc => bookings.push({ id: doc.id, ...doc.data() }));

                // Sort by creation date (newest first)
                bookings.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                bookings.forEach(booking => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 hover:bg-blue-50/50 transition-colors group';
                    
                    // Date Logic (When the booking was made)
                    let createdDate = 'N/A';
                    if (booking.createdAt && booking.createdAt.seconds) {
                         createdDate = new Date(booking.createdAt.seconds * 1000).toLocaleDateString();
                    } else if (booking.date) {
                         createdDate = booking.date; 
                    }

                    // Scheduled Logic (The user's preferred date/time)
                    let scheduledStr = '<span class="text-gray-400 text-xs">Pending</span>';
                    if (booking.shootDate) {
                        // Format date to look nicer
                        const dateObj = new Date(booking.shootDate);
                        const prettyDate = isNaN(dateObj) ? booking.shootDate : dateObj.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                        const timeStr = booking.shootTime ? `<span class="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded ml-1 text-xs font-bold">${booking.shootTime}</span>` : '';
                        scheduledStr = `<div class="flex items-center text-gray-800 font-medium">${prettyDate} ${timeStr}</div>`;
                    }

                    // Location Logic
                    const locationStr = `${booking.locationPlace || ''} ${booking.locationPincode ? '<span class="text-xs text-gray-400 block">' + booking.locationPincode + '</span>' : ''}`.trim() || '-';

                    // Status Logic
                    let statusColor = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                    let statusIcon = 'clock';
                    if (booking.status === 'confirmed') { statusColor = 'bg-green-100 text-green-800 border-green-200'; statusIcon = 'check-circle'; }
                    if (booking.status === 'cancelled') { statusColor = 'bg-red-100 text-red-800 border-red-200'; statusIcon = 'x-circle'; }

                    row.innerHTML = `
                        <td class="p-4 text-xs text-gray-500 whitespace-nowrap">${createdDate}</td>
                        <td class="p-4">${scheduledStr}</td> <!-- NEW SCHEDULED COLUMN -->
                        <td class="p-4 font-bold text-gray-800">${booking.customerName || 'Unknown'}</td>
                        <td class="p-4 text-sm text-gray-600">
                            <div class="flex flex-col gap-1">
                                <span>${booking.customerEmail || '-'}</span>
                                <span class="text-xs text-gray-400">${booking.customerPhone || '-'}</span>
                            </div>
                        </td>
                        <td class="p-4 text-sm text-gray-600 font-medium"><span class="bg-gray-100 border border-gray-200 px-2 py-1 rounded">${booking.platform || booking.plan || '-'}</span></td>
                        <td class="p-4 text-sm text-gray-600">${locationStr}</td>
                        <td class="p-4 text-xs text-gray-500 max-w-[200px] truncate" title="${booking.vision || ''}">${booking.vision || '-'}</td>
                        <td class="p-4">
                            <span class="px-2.5 py-1 rounded-full text-xs font-bold border flex items-center gap-1 w-fit ${statusColor}">
                                <i data-lucide="${statusIcon}" class="w-3 h-3"></i> ${booking.status || 'pending'}
                            </span>
                        </td>
                        <td class="p-4 text-center">
                            <div class="flex items-center gap-2 justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="updateStatus('${booking.id}', 'confirmed')" class="p-2 bg-green-50 text-green-600 rounded hover:bg-green-100 transition-colors" title="Confirm"><i data-lucide="check" class="w-4 h-4"></i></button>
                                <button onclick="updateStatus('${booking.id}', 'cancelled')" class="p-2 bg-red-50 text-red-600 rounded hover:bg-red-100 transition-colors" title="Cancel"><i data-lucide="x" class="w-4 h-4"></i></button>
                                <button onclick="deleteBooking('${booking.id}')" class="p-2 bg-gray-50 text-gray-400 rounded hover:bg-gray-200 hover:text-gray-600 transition-colors" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </td>
                    `;
                    bookingsTableBody.appendChild(row);
                });
                lucide.createIcons();
            });
        }

        // --- TICKETS LOGIC (NEW) ---
        function loadTickets() {
            const ticketsTableBody = document.getElementById('ticketsTableBody');
            // Assuming tickets are stored in 'issues' collection as per index.html
            const ticketsRef = collection(db, 'artifacts', appId, 'public', 'data', 'issues');
            
            onSnapshot(ticketsRef, (snapshot) => {
                ticketsTableBody.innerHTML = '';
                
                if (snapshot.empty) {
                    ticketsTableBody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500 font-medium">No tickets found.</td></tr>';
                    return;
                }

                const tickets = [];
                snapshot.forEach(doc => tickets.push({ id: doc.id, ...doc.data() }));

                // Sort by creation date (newest first)
                tickets.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                tickets.forEach(ticket => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 hover:bg-purple-50/50 transition-colors group';
                    
                    let createdDate = 'N/A';
                    if (ticket.createdAt && ticket.createdAt.seconds) {
                         createdDate = new Date(ticket.createdAt.seconds * 1000).toLocaleString();
                    }

                    let statusColor = 'bg-blue-100 text-blue-800 border-blue-200';
                    if (ticket.status === 'Resolved') statusColor = 'bg-gray-100 text-gray-600 border-gray-200 decoration-line-through opacity-75';

                    row.innerHTML = `
                        <td class="p-4 text-xs text-gray-500 whitespace-nowrap">${createdDate}</td>
                        <td class="p-4 font-medium text-gray-800">${ticket.userEmail || 'Anonymous'}</td>
                        <td class="p-4 text-sm text-gray-600 max-w-md">
                            <p class="line-clamp-2" title="${ticket.issue}">${ticket.issue}</p>
                        </td>
                        <td class="p-4">
                            <span class="px-2.5 py-1 rounded-full text-xs font-bold border w-fit ${statusColor}">
                                ${ticket.status || 'Open'}
                            </span>
                        </td>
                        <td class="p-4 text-center">
                            <div class="flex items-center gap-2 justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="updateTicketStatus('${ticket.id}', 'Resolved')" class="p-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors" title="Mark Resolved"><i data-lucide="check-square" class="w-4 h-4"></i></button>
                                <button onclick="deleteTicket('${ticket.id}')" class="p-2 bg-gray-50 text-gray-400 rounded hover:bg-gray-200 hover:text-gray-600 transition-colors" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </td>
                    `;
                    ticketsTableBody.appendChild(row);
                });
                lucide.createIcons();
            });
        }

        // --- GLOBAL ACTIONS ---
        window.updateStatus = async (id, newStatus) => {
            try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', id), { status: newStatus }); }
            catch (e) { alert("Error: " + e.message); }
        };

        window.deleteBooking = async (id) => {
            if(confirm('Permanently delete this booking?')) {
                try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', id)); }
                catch (e) { alert("Error: " + e.message); }
            }
        };

        // Ticket Actions
        window.updateTicketStatus = async (id, newStatus) => {
            try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'issues', id), { status: newStatus }); }
            catch (e) { alert("Error: " + e.message); }
        };

        window.deleteTicket = async (id) => {
            if(confirm('Permanently delete this ticket?')) {
                try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'issues', id)); }
                catch (e) { alert("Error: " + e.message); }
            }
        };
    </script>
</head>
<body class="bg-gray-50 font-sans h-screen overflow-hidden flex flex-col">

    <!-- LOGIN -->
    <div id="loginOverlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full border border-gray-100">
            <div class="mb-6 flex justify-center text-red-600"><i data-lucide="shield-check" class="w-16 h-16"></i></div>
            <h2 class="text-3xl font-black mb-2 text-gray-900">Admin Access</h2>
            <p class="text-gray-500 mb-8">Authorized personnel only.</p>
            <button id="googleLoginBtn" class="w-full bg-black text-white font-bold py-4 rounded-xl hover:bg-gray-900 transition-all flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5 bg-white rounded-full p-0.5">
                Sign in with Google
            </button>
            <div id="authErrorMsg" class="hidden mt-6 p-3 bg-red-50 text-red-600 text-sm rounded-lg font-medium"></div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="flex-1 flex flex-col hidden h-full">
        <!-- Top Nav -->
        <header class="bg-white border-b border-gray-200 h-16 flex justify-between items-center px-8 z-10">
            <div class="flex items-center gap-2">
                <div class="bg-black text-white p-1.5 rounded"><i data-lucide="zap" class="w-5 h-5 fill-current"></i></div>
                <h1 class="text-xl font-black tracking-tight text-gray-900">VibeSnap <span class="text-red-600">Admin</span></h1>
            </div>
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-2 text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1.5 rounded-full">
                    <i data-lucide="user" class="w-4 h-4"></i>
                    <span id="userEmailDisplay"></span>
                </div>
                <button id="logoutBtn" class="text-red-500 hover:text-red-700 text-sm font-bold flex items-center gap-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Logout
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto p-8 space-y-8 bg-gray-50">
            
            <!-- Stats Row (Optional Placeholder) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-2">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                    <div class="p-3 bg-blue-50 text-blue-600 rounded-lg"><i data-lucide="calendar" class="w-6 h-6"></i></div>
                    <div><p class="text-sm text-gray-500 font-bold uppercase tracking-wider">Bookings</p><p class="text-2xl font-black text-gray-900">Manage</p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                    <div class="p-3 bg-purple-50 text-purple-600 rounded-lg"><i data-lucide="ticket" class="w-6 h-6"></i></div>
                    <div><p class="text-sm text-gray-500 font-bold uppercase tracking-wider">Support</p><p class="text-2xl font-black text-gray-900">Tickets</p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                    <div class="p-3 bg-green-50 text-green-600 rounded-lg"><i data-lucide="trending-up" class="w-6 h-6"></i></div>
                    <div><p class="text-sm text-gray-500 font-bold uppercase tracking-wider">Status</p><p class="text-2xl font-black text-gray-900">Live</p></div>
                </div>
            </div>

            <!-- BOOKINGS SECTION -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                    <h2 class="text-lg font-black text-gray-800 flex items-center gap-2">
                        <i data-lucide="camera" class="w-5 h-5 text-red-600"></i> Shoot Bookings
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50/50 border-b border-gray-200">
                            <tr>
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider">Booked On</th>
                                <th class="p-4 text-xs font-bold uppercase text-gray-900 tracking-wider">Scheduled Shoot</th> <!-- New Column -->
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider">Client Name</th>
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider">Contact</th>
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider">Plan</th>
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider">Location</th>
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider">Vision</th>
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider">Status</th>
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTableBody" class="divide-y divide-gray-100 bg-white">
                            <!-- Rows injected via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TICKETS SECTION (NEW) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white">
                    <h2 class="text-lg font-black text-gray-800 flex items-center gap-2">
                        <i data-lucide="message-circle" class="w-5 h-5 text-purple-600"></i> Customer Tickets
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50/50 border-b border-gray-200">
                            <tr>
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider">Date</th>
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider">User Email</th>
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider">Issue Description</th>
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider">Status</th>
                                <th class="p-4 text-xs font-bold uppercase text-gray-400 tracking-wider text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ticketsTableBody" class="divide-y divide-gray-100 bg-white">
                            <!-- Rows injected via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>
    
    <script>
        // Initialize icons immediately
        lucide.createIcons();
    </script>
</body>
</html>